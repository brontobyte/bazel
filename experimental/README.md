### Experimentation on package configuration

# Status

This is a prototype. It lacks proper tests and complete documentation.

# Usage

Simply run `./bazel-configure.sh` to run the standalone version on
the examples and `bazel build //experimental/examples:config` to run
the Bazel version (note that this will not work under Linux where
the default JDK is not a JDK 8 because Bazel does not provide
environment variables to genrule so the `JAVA_HOME` environment
variable will be null).

`//experimental/init` contains the basic scripts. `bazel-init.py` and
`bazel-init.bzl` are examples on how it would be decomposed if
integrated into a propre build / skyframe rotation: a detection phase
and a generation. The generation output is actually identical to a
build whereas the detection is non-hermetic. A bunch of hacks into
`bazel-init.bzl` where needed to make it work inside bazel. It
generates a ZIP file containing the "hidden" workspace.

`init-standalone.py` is a standalone script that generates the
"hidden" workspace inside the `output_base`. To test it, you must
copy the `*jar` tools from `tools/jdk` to the embedded binary
directory of the bazel `install_base`. The idea is to package the
essential binaries inside the Bazel zip so we can finally ship a
standalone binary.

Both script load external modules. `init-standalone.py` expect them to
be provided on the command line and `bazel-init.bzl` expects
`package_conf` target as dependencies of a `bazel_configure` target.
Examples of such modules are provided in
`//experimental/examples` (see the `BUILD` file for how to use
`bazel-init.bzl`). Each modules declare three methods:

- `package` returns the path to the package this module configure.
- `autodetect` takes a configuration object and an helper and returns
  another  configuration object. The helper is an `AutodetectHelper`
  that contains methods to discover objects on the system. The input
  configuration object should represent a mix of the existing value
  and the one provided by the user. _The input  configuration object
  is not yet  supported_.
- `generate` takes a configuration object as generated by `autodetect`
  as well as an `BuildGeneratorHelper`. The helper provide a set of
  convenience method to generates rules and file into the target package.

# Notes

1. The init-fromhost module generates the `fromhost` package with the
   `libarchive` target, we might want to provide modules for
   generating librarie target and so multiple modules for only one
   package.
2. We would gain a lot to have this integrated into Bazel / SkyFrame as we
   could:
     - remove the need for the merge step,
	 - remote the need to list all dependencies,
	 - integrate the install base and remove the need to add the
       `package_path` option in the `.bazelrc`,
	 - cache the value of detection methods accross modules.
3. The support for `pkg-config` / `brew` / `port` is really basic.
4. We generate a second `WORKSPACE` file in the "hidden" directory and
   we should merge it with the workspace's own file. If I understand
   correctly, the WORKSPACE file in the workspace will hide the one in
   the "hidden" directory.
5. Current mode wipe out the folder but we can make an incremental
   mode that rewrite only the package needed and by caching WORKSPACE
   parts, no need to regenerate the whole WORKSPACE file.
6. The current plan of `bazel init` is to have the configure then the
   `bazel fetch` but if we could interleave the two and discover
   configuration modules as we download them in the fetch operation
   then we could make possible configuration of remote repositories too.
7. There is no support for user input nor configuration cache here, it
   could be done easily by serializing the configuration object. How
   we keep it is, I believe, totally internal to bazel and could be
   kept in the bazel output tree (removing the need for parsing build
   files). Making it user-settable is needed if we cannot find the
   desired library because of a special set-up.
